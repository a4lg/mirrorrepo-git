mirrorrepo-git : 共通オブジェクトを活用する git ミラーリング
=============================================================


注意点
-------

このツールはまだ開発途中です。
ツールの使用は、状況によっては安全でないことがあります。

今のところ、このツールは GC 機能を持っていません。
このツールは多くの参照をオブジェクト削除防止のために保持します。
しかし、多くの参照は複数の fetch の後不要となります。
このような不要な参照を削除する機能は後のステージで追加する予定です。


このツールは?
--------------

これはのリモート git リポジトリのスナップショットを取り、
必要に応じて復元するためのツールです。
複数のリポジトリから fetch することにより、
ディスクスペースを削減することができます。


なぜこのツールが必要だったのか?
--------------------------------

このツールを開発した理由は、次の 3 つです。

1 つめ。`git fetch` は基本的に削除されたブランチやタグに追従しないことです。
私は、リモートリポジトリの正確なスナップショットを取りたかったのです。

2 つめとして、時々ブランチやタグは (forced update により)
置き換えられることがあります。私が複数の Linux SoC
リポジトリで作業していたとき、あるときひとつのブランチが置き換わり、
全く違ったコミット履歴となっていたのです。
私は理由に関わらずコミット履歴を永遠に残すことを求めました。

3 つめ、このようなツールを作ればディスク領域を節約できることです。
複数の Linux カーネルリポジトリで作業していると、
ほとんどの内容は同じであることに気づきます。git リポジトリというのは、
基本的にデルタ圧縮されたオブジェクトストアです。
そのため重複した内容を同一ストアに収めることができれば、
このツールが達成するようにディスク領域を削減できます。


必要環境
---------

*	POSIX 準拠のシェル
*	POSIX 準拠のコアコマンド集
*	`mktemp` ユーティリティ  
	このツールは POSIX の一部ではありません。ただほとんどの環境で、
	このツールがインストールされているはずです (GNU Coreutils / BSD...)。
*	`git`  
	このツールは多数の領域において git に依存します。


このツールによってアーカイブされるもの / されないもの
------------------------------------------------------

アーカイブされるもの:
*	全ての git "参照" のスナップショット:
	*	ブランチ
	*	タグ
	*	ノート
*	スナップショットに紐付いたオブジェクト:
	*	コミットツリー
	*	ソースコードファイル

アーカイブされないもの:
*	シンボリックな git "参照"  
	`git upload-pack` は全ての git "参照" を SHA-1 ID として送るため、
	このツールはシンボリックな参照をそのまま保存することができません
	(全ての `git fetch` 基盤ツールと同様)。
*	リポジトリの "説明" (description)  
	`git fetch` は description に手を触れません。
	手段によっては、description を取得できないことすらあるのです。


使い方の例
-----------

最初に、mirrorrepo-git 用のディレクトリを作成する必要があります。

	$ mkdir linux-kernels
	$ cd linux-kernels
	$ mirrorrepo-git init

そして、リモートリポジトリを追加する必要があります。

	$ mirrorrepo-git add korg git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

複数追加しても構いません。

	$ mirrorrepo-git add linux-next git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git

リモート参照を削除することは可能ですが、推奨されません。
というのも mirrorrepo-git は削除された git "参照" をそのままにするからです。
ただし、現状リモート名を変更するのには役立つかもしれません。

	$ mirrorrepo-git del linux-next
	$ mirrorrepo-git add korg-next git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git

`fetch` コマンドを用いて、リモートリポジトリを取得することができます。

	$ mirrorrepo-git fetch korg

`fetch-all` コマンドを用いて全てのリモートを取得することもできます。

	$ mirrorrepo-git fetch-all

一度 fetch したならば、ローカルミラーを更新 (`update`) することが可能です。

	$ mirrorrepo-git update korg-next

`fetch-all` と同じく、`update-all` を使うこともできます。

	$ mirrorrepo-git update-all

ローカルミラーは `mirrors/korg` と `mirrors/korg-next` にあります。
これらローカルミラーは軽く作れる動的なミラーとして使われることを想定します。
`fetch` コマンドでスナップショット ID を指定しなかった場合、
`update` 後のローカルミラーは常に "最新" の状態です。

もちろん、フリーズされたスナップショットを作ることができます。
現状このツールは取得したスナップショット ID を確認する手段がありません。
そのため、refs-history において `git log` を実行する必要があります。

	$ cd refs-history/korg
	$ git log --format=oneline
	....
	$ cd ../..

もし必要なスナップショットの SHA-1 ID が `01234567...` なら、
このようにしてフリーズされたスナップショットを作成できます。

	$ mirrorrepo-git snapshot korg korg-snapshot-1 01234567

出力は `snapshots/korg-snapshot-1` にあります。

リポジトリをエクスポートしたい場合、`export` コマンドが使えます。
スナップショットと同様にエクスポートする場合 (デフォルト):

	$ mirrorrepo-git export korg /path/to/repository.git 01234567

エクスポートする場合、通常作成されるような開発用ツリーを
`-d` オプションによって作成できます。
また、`--secure` オプションを使うことによって、
共通オブジェクトストアからリポジトリを切り離すことが可能です。
切り離されたリポジトリは他のマシンに安全にコピーすることができます。

	$ mirrorrepo-git export -d --secure korg /path/to/repository 01234567


複合リポジトリフォーマット
---------------------------

`init` コマンドを実行すると、
複合リポジトリが現在のディレクトリに作成されます。
全てのアーカイブされたオブジェクトを格納するための bare な
git リポジトリは現在のディレクトリに作成され、
他のメタデータなどを含めて複合リポジトリと呼びます。

中央のこれだけではなく、他の bare リポジトリも存在します。

*	refs-history/NAME  
	"refs" ファイルに全ての git "参照" を保持するリポジトリです。
	ミラー/スナップショット作成時に使用され、fetch 時に更新されます。
*	mirrors/NAME  
	`update` コマンドで更新されるデフォルトのローカルミラーです。
*	snapshots/NAME  
	`snapshot` コマンドで作成されるスナップショットです。


セキュリティ上の注意点
-----------------------

リモートリポジトリからの fetch を行う場合、
デフォルトでは他のリモートリポジトリの情報を漏らすことがあります。
`--secure` を指定することで、mirrorrepo-git はやや効率の悪い方法で
fetch を実施します (ただそこまで "非効率的" でもない)。

ローカルミラーやスナップショットから fetch を行う場合、
他のリポジトリの情報を漏らすことがあります。これは仕様です。
このような動作を避けたい場合、`--secure` オプションを用いて
export してください。この方法でエクスポートされたリポジトリは
情報漏洩を起こしません (オブジェクトストレージを共有しないため)。


ライセンス
-----------

このプログラムは ISC ライセンスの下で提供されています。

	Copyright(C) 2015 Tsukasa OI.
